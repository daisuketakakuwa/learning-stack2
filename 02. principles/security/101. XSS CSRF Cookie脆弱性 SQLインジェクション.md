# Special Thanks
- [XSSã‚’ç†è§£ã—ã¦å®‰å…¨ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹](https://zenn.dev/oreo2990/articles/d33a264b2d8b4c)
- [Cross-Site Request Forgery Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#verifying-origin-with-standard-headers)
- [Spring Security ã§CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã£ã¦ã¿ã‚‹](https://baubaubau.hatenablog.com/entry/2020/11/23/205726)

# XSSï¼ˆCross-site Scriptingï¼‰
Webã‚µã‚¤ãƒˆå†…ã«maliciousãªClientã‚³ãƒ¼ãƒ‰(UserãŒå…¥åŠ›ã—ãŸã‚„ã¤)ã‚’åŸ‹ã‚è¾¼ã‚ã¡ã‚ƒã†ã€‚<br>
 ã€€ã€€||<br>
ãƒ–ãƒ©ã‚¦ã‚¶å´ã‹ã‚µãƒ¼ãƒå´ã§ç”Ÿæˆã•ã‚ŒãŸHTMLã‚’èª­è¾¼ â†’ ScriptãŒå®Ÿè¡Œã•ã‚Œã¡ã‚ƒã†!!!

âœ…**HTMLã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹ã“ã¨ã«æ¼¬ã‘è¾¼ã‚“ã ã‚„ã¤ã€‚**

è‰¯ã„ã¨æ€ã£ãŸèª¬æ˜

> XSSã¨ã¯å‹•çš„ã«HTMLã‚’ç”Ÿæˆã™ã‚‹Webã‚µã‚¤ãƒˆ(1:ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã‚„ã‚‹SPA/2.ã‚µãƒ¼ãƒä¸Šã§å‹•çš„ãƒšãƒ¼ã‚¸ç”Ÿæˆ)ã§æ‚ªæ„ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒåŸ‹ã‚è¾¼ã¾ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’HTMLã¨ã—ã¦ãã®ã¾ã¾è¡¨ç¤ºã—ãŸéš›ã«ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹æ”»æ’ƒæ‰‹æ³•(ã¾ãŸã¯è„†å¼±æ€§)ã§ã™ã€‚
[XSSã‚’ç†è§£ã—ã¦å®‰å…¨ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹](https://zenn.dev/oreo2990/articles/d33a264b2d8b4c)

> Cross-site scripting (XSS) is a security exploit which allows an attacker to **inject into a website malicious client-side code**. This code is executed by the victims and lets the attackers bypass access controls and impersonate users.
[mdn web docs - Cross-site scripting (XSS)](https://developer.mozilla.org/en-US/docs/Glossary/Cross-site_scripting)

## XSS 3ç¨®é¡
### Reflected/Non-persistent
Reflect/åå°„ = URLã‚’ã‚¯ãƒªãƒƒã‚¯â†’ã‚µãƒ¼ãƒå´ã§å‹•çš„ãƒšãƒ¼ã‚¸ç”Ÿæˆâ†’Browserã§HTMLèª­è¾¼â†’Scriptå®Ÿè¡Œ
URLã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã™ãã«åæ˜ ã•ã‚Œã¡ã‚ƒã†æ„Ÿã˜ã‹ãªã€‚
### Stored/Persistent
POSTã—ã¦DBã«æ ¼ç´ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿(ä¾‹: æŠ•ç¨¿)ã‚’ç”»é¢ã«è¡¨ç¤º(ã‚µãƒ¼ãƒå´ã§å‹•çš„ãƒšãƒ¼ã‚¸ç”Ÿæˆ)ã—ãŸã¨ãã«Scriptå®Ÿè¡Œã€‚MaliciousãªScriptãŒDBå†…ã«"æ ¼ç´"ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‰"Stored/Persistent"ã€‚
### DOM-based
ã‚µãƒ¼ãƒå´ã§ã¯ãªãã€ãƒ–ãƒ©ã‚¦ã‚¶å´ã§HTMLãŒç”Ÿæˆ(è¦ã¯SPAçš„ãª)ã•ã‚ŒãŸã¨ãã®è©±ã€‚
ãƒ—ãƒ¬ãƒ¼ãƒ³ãªHTMLã‚’å‹•çš„ã«æ³¨å…¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹Vue.jsã®`v-html`ç­‰ã€‚

|XSSç¨®é¡|HTMLç”Ÿæˆå ´æ‰€|ã©ã†ã‚„ã£ã¦ï¼Ÿ|
|----|----|----|
|Reflected XSS|ã‚µãƒ¼ãƒ|URLã‚¯ãƒªãƒƒã‚¯|
|Stored XSS|ã‚µãƒ¼ãƒ|äº‹å‰ã«DBã¸MaliciousãªScriptè¾¼ãƒ‡ãƒ¼ã‚¿ã‚’POST|
|DOM-based XSS|ãƒ–ãƒ©ã‚¦ã‚¶|

## XSSå¯¾ç­–
UserãŒå…¥åŠ›ã—ãŸã‚‚ã®ã¯**ã¡ã‚ƒã‚“ã¨Validation/Encoding(ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†)ã—ã‚ˆã†**ã­ã€‚
```:HTMLã®æ–‡æ³•ä¸Šç‰¹åˆ¥ãªæ„å‘³ã‚’æŒã¤ç‰¹æ®Šè¨˜å·(ãƒ¡ã‚¿æ–‡å­—)
<ã€€â†’ã€€&lt;
>ã€€â†’ã€€&gt;
&ã€€â†’ã€€&amp;
"ã€€â†’ã€€&quot;
'ã€€â†’ã€€&apos;
```

# CSRF
> CSRF (Cross-Site Request Forgery) is an attack that **impersonates** a trusted user(ãƒ­ã‚°ã‚¤ãƒ³ä¸­/èªè¨¼æ¸ˆã®User) and sends a website unwanted commands.

> Cross-Site Request Forgery (CSRF) is a type of attack that occurs when a **malicious web site, email, blog, instant message, or program** causes a user's web browser to perform an unwanted action on a trusted site when the user is authenticated. 

âœ…**ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚ˆã‚‹SessionIDCookieãŒè‡ªå‹•é€ä¿¡ã•ã‚Œã‚‹ä»•çµ„ã¿ã«æ¼¬ã‘è¾¼ã‚“ã ã‚„ã¤ã€‚**
â†’ è£ã‚’è¿”ã›ã°ğŸ”´Sessionã‚’ä½¿ã‚ãªã‘ã‚Œã°CSRFã¯ç™ºç”Ÿã—ãªã„ğŸ”´

âœ…å¤–éƒ¨ã‚µã‚¤ãƒˆ(akui.com)ã€ãƒ¡ãƒ¼ãƒ«ã€ãƒ–ãƒ­ã‚°ã€SMSã€ãƒ„ã‚¤ãƒ¼ãƒˆç­‰**ã¨ã«ã‹ãURLã‚’å…±æœ‰ã§ãã‚‹åª’ä½“**ã§ã‚ã‚Œã°ä½•ã§ã‚‚ã€‚= ã“ã‚Œã‚‰å…¨ã¦ãŒCrossOriginã«ãªã‚‹(URLç›´å©ãã§ã‚ã‚Œã°Origin:null)ã€‚

âœ…ãªã‚Šã™ã¾ã—Userã«ã‚„ã‚‰ã‚Œã¦å›°ã‚‹ã®ã¯**æ›´æ–°/å‰Šé™¤ç³»ã®å‡¦ç†**ã€‚
â†’ SpringSecurityã®å ´åˆã€CSRFå¯¾ç­–ã‚’ã™ã‚‹HTTPãƒ¡ã‚½ãƒƒãƒ‰(POST/PUT/DELETE)ã®ã¿CSRFå¯¾ç­–(CSRFãƒˆãƒ¼ã‚¯ãƒ³åˆ¶å¾¡)ãŒé©ç”¨ã•ã‚Œã‚‹ã€‚

https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html

## CSRF ã®ä¾‹
â†“ã®ã‚ˆã†ã«**èªè¨¼æ¸ˆã®ã‚µã‚¤ãƒˆ/APIã«å¯¾ã™ã‚‹æ›´æ–°ç³»URLã‚’ã€ã‚¯ãƒªãƒƒã‚¯ã•ã›ã‚‰ã‚ŒãŸã‚‰**ãã‚Œã§CSRFæ”»æ’ƒãŒæˆç«‹ã€‚å¤–éƒ¨ã‚µã‚¤ãƒˆçµŒç”±ã§ã‚‚ã„ã„ã—ã€ãƒ„ã‚¤ãƒ¼ãƒˆçµŒç”±ã§ã‚‚ã„ã„ã ã‚ã†ã€‚

![](https://storage.googleapis.com/zenn-user-upload/74c87bad53dd-20230523.png)

## CSRF å¯¾ç­–
1. synchronizer token pattern
2. FWå‚™ãˆä»˜ãã®CSRF Protection
3. Cookieã«SameSiteå±æ€§

### synchronizer token pattern
âœ…ãƒã‚¤ãƒ³ãƒˆã¯ã€Œæœ€åˆã«GETã—ã¦csrfãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã€ã™ã‚‹ã¨ã“ã‚ã€‚
â†“ã®SpringSecurityã§è©³ç´°ã¯æ›¸ãã€‚è¦ç‚¹ã ã‘ã¾ã¨ã‚ã‚‹ã¨

ï¼ã‚µãƒ¼ãƒå´ã§å‹•çš„ãƒšãƒ¼ã‚¸ç”Ÿæˆã®å ´åˆï¼<br>
âœ…æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿…è¦ãªCSRFãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€æ›´æ–°ç”¨ç”»é¢ã‚’GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ç”Ÿæˆã—ãŸã¨ãã«HTMLå†…ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ãŸã‚ã€æ›´æ–°ç”¨ç”»é¢ã‚’é–‹ã‘ãªã„æ‚ªè€…ã¯CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ããªã„ï¼†ç›´æ¥POSTã—ã¦ã‚‚CSRFãƒˆãƒ¼ã‚¯ãƒ³ãªã„ã‹ã‚‰NGã¨ãªã‚‹ã€‚

ï¼REST APIã®å ´åˆï¼<br>
âœ…JWTèªè¨¼(Sessionä½¿ã‚ãªã„ä»•çµ„ã¿)ã®å ´åˆã€CSRFå¯¾ç­–ã¯ä¸è¦ã€‚<br>
âœ…SessionIDèªè¨¼ã®å ´åˆã€è‡ªå‹•ã§SessionIDCookieãŒé€ä¿¡ã•ã‚Œã‚‹ã®ã§å¯¾å¿œãŒå¿…è¦ã€‚

### FWå‚™ãˆä»˜ãã®CSRF Protection(ä¾‹:Spring Security)
å…ˆè¿°ã—ãŸ`synchronizer token pattern`(csrfãƒˆãƒ¼ã‚¯ãƒ³)ã®ä»•çµ„ã¿ã‚’è‡ªå‹•ã§ã‚„ã£ã¦ãã‚Œã‚‹ã€‚
é¦´æŸ“ã¿ã®Springã§ã¯SpringSecurityãŒã‚„ã£ã¦ãã‚Œã¦ã„ã‚‹ã€‚(
[Spring Security ã® CSRF å¯¾ç­–ã‚’å­¦ã¼ã†](https://qiita.com/d-yosh/items/c76938057a634eed0d6f))
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§CSRFå¯¾ç­–ãŒé©ç”¨ã•ã‚Œã‚‹ã€‚
- **ã‚µãƒ¼ãƒå´ã§å‹•çš„HTMLç”Ÿæˆã®å ´åˆ**ã€æœ€åˆã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«HTMLå†…ã«CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’`type=hidden`ã§åŸ‹ã‚è¾¼ã‚€ã€‚= ã‚ã¨ã§POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨ãã«CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒé€ä¿¡ğŸ‘
```html
<input name="${_csrf.parameterName}" type="hidden" value="${_csrf.token}"/>
```

> Spring **adds a CSRF token to each generated view**. This token must be submitted to the server on **every HTTP request that modifies state** (PATCH, POST, PUT and DELETE â€” not GET). 
[Baeldungï½œA Guide to CSRF Protection in Spring Security](https://www.baeldung.com/spring-security-csrf)

âœ…JWTèªè¨¼ã®REST APIã®å ´åˆã€CSRFå¯¾ç­–ã¯ä¸è¦ã€‚<br>
âœ…SessionIDèªè¨¼ã®REST APIã®å ´åˆã€CSRFå¯¾ç­–ãŒå¿…è¦ â†’ **Double Submit Cookie**
- CSRFãƒˆãƒ¼ã‚¯ãƒ³è¾¼ã®Cookie(XSRF-TOKEN)ã‚’ç”Ÿæˆï¼†ãƒ•ãƒ­ãƒ³ãƒˆã«è¿”ã™ã€‚
- ãƒ•ãƒ­ãƒ³ãƒˆå´ã§JSã§Cookieã‹ã‚‰CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã€‚
- REST APIã®`X-XSRF-TOKEN`ãƒ˜ãƒƒãƒ€ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚»ãƒƒãƒˆï¼†é€ä¿¡ã€‚

è¦å‚è€ƒï¼š[Baeldungï½œA Guide to CSRF Protection in Spring Security](https://www.baeldung.com/spring-security-csrf)

### Cookieã«SameSiteå±æ€§
ã“ã®å±æ€§ã‚’SessionIDCookieã«è¨­å®šã™ã‚‹ï¼åŒã˜Originã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿SessionIDCookieã‚’é€ä¿¡ã™ã‚‹=**ã“ã®Origin/ã‚µãƒ¼ãƒãŒç”Ÿæˆã—ãŸHTMLå†…ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿å—ã‘ä»˜ã‘ã‚‹ã€‚**
```
Set-Cookie: mykey=myvalue; SameSite=Strict
```

[mdn web docsï½œHTTP Cookie ã®ä½¿ç”¨](https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies)

# Cookieè„†å¼±æ€§
Cookieã®è¨­å®šä¸è¶³ã«ã‚ˆã£ã¦å¼•ãèµ·ã“ã•ã‚Œã‚‹è„†å¼±æ€§ã€‚ä¸»ã«ä¸‹è¨˜ï¼’ã¤ã®å±æ€§è¨­å®šå¿˜ã‚Œã€‚
|å±æ€§|èª¬æ˜|
|----|----|
|httponly|Document.cookie APIçµŒç”±ã§Scriptå†…ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚|
|secure|HTTPSæ™‚ã®ã¿é€ä¿¡ã•ã‚Œã‚‹ã€‚|

ã€€ä¾‹1) XSSã§Cookieå†…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’æŠœãå–ã‚Š(httponlyå±æ€§ãªã—)ã€åˆ¥ã‚µã‚¤ãƒˆã¸é€ä¿¡ã€‚
 
# SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³
SQL injection takes advantage of Web apps that fail to validate user input. Hackers can **maliciously pass SQL commands through the Web app for execution by a backend database.**
 
 https://developer.mozilla.org/ja/docs/Glossary/SQL_Injection
 
 # Client DOM XSS
âœ… React > JSXå†…ã®å¼åŸ‹ã‚è¾¼ã¿ã§ã¯ã€åŸºæœ¬çš„ã«HTMLã¨ã—ã¦è§£é‡ˆã•ã‚Œãªã„ã‚ˆã†ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚Œã‚‹ã€‚<br>
âœ… Redux Store > èª­ã¿å–ã‚Šå°‚ç”¨ã€‚é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã‹ã‚‰æ›´æ–°ä¸å¯èƒ½ã€‚<

https://qiita.com/kazzzzzz/items/897f8ed89ca36a0734de

# Prototype Pollution

[ã“ã®è¨˜äº‹](https://jovi0608.hatenablog.com/entry/2018/10/19/083725)ãŒåˆ†ã‹ã‚Šã‚„ã™ã‹ã£ãŸã€‚

ç¾å ´ã§å®Ÿéš›ã«Prototype Pollutionã¨ã—ã¦æ¤œçŸ¥ã•ã‚ŒãŸã‚‚ã®ã€‚
```js
    getCookie: function () {
      // var _5
      // ã“ã“ã§ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
      var _5e = new Object();
      var _5f = document.cookie;
      if (_5f != "") {
        var _60 = _5f.split(";");
        for (var _61 = 0; _61 < _60.length; _61++) {
          var _62 = _60[_61].split("=");
          var key = InkTool.InkLib.trimWhiteSpace(_62[0]);
          var val = InkTool.InkLib.trimWhiteSpace(decodeURIComponent(_62[1]));
	  // ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ(_5e)ã«ã€document.cookieã‚’INPUTã«ã—ã¦ã„ã‚‹keyã‚’è¿½åŠ ã—ã¦ã„ã‚‹ã€‚
	  // ã“ã®keyãŒ"__proto__.polluted"ã ã£ãŸã‚‰æ±šæŸ“ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚‹ã€‚
          _5e[key] = val;
        }
      }
      return _5e;
    },
```
