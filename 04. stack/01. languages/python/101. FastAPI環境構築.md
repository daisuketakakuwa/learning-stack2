# Special Thanks
ãƒ»[An Introduction to ASGI, Asynchronous Server Gateway Interface](https://www.youtube.com/watch?v=uRcnaI8Hnzg)<br>
ãƒ»[Review Of 5 Cloud Services For Python FastAPI Deployment](https://medium.com/codex/review-of-5-cloud-services-for-python-fastapi-deployment-5e40569e29)
ãƒ»[fastapi-best-practices](https://github.com/zhanymkanov/fastapi-best-practices)

# ãƒ¡ãƒ¢
âœ… WSGI or ASGIé¸æŠã€€â†’ Framework ã¨ Server ã¯ WSGIã‹ASGIã‹ã§å¤‰ã‚ã£ã¦ãã‚‹ã€‚<br>
âœ… **WEBã‚µãƒ¼ãƒ(Apache/Nginx) ã¨ WSGIã‚µãƒ¼ãƒã‚’ä½µç”¨ã™ã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚‹ğŸ‘**<br>
<br>
ã€€ã€€ã€€Browser <-> Apache/Nginx <-> WSGIã‚µãƒ¼ãƒ<br>
<br>
ã®ã‚ˆã†ã« APIã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’WEBã‚µãƒ¼ãƒã«ä¸­ç¶™ã•ã›ã‚‹ã‹ã‚‰ã€CrossOriginãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒãªã„ã€‚<br>

## ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•æ–¹æ³•
ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«ã«uvicornã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« â†’ uvicornä¸Šã§FastAPIã‚¢ãƒ—ãƒªèµ·å‹•ã™ã‚Œã°OKã€‚<br>
âœ…**Uvicornæ­è¼‰ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸**ã‚’åˆ©ç”¨ã™ã‚‹ã€‚[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://fastapi.tiangolo.com/ja/deployment/docker/)
## Cloudã‚µãƒ¼ãƒ“ã‚¹(ã„ãšã‚Œã‚‚Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç™»éŒ²ã™ã‚‹ã ã‘)
ãƒ»Google Cloud Run
ãƒ»Microsoft Azure Web App Service

# WSGI vs ASGI
ğŸ‘‰ WSGI, ASGI ã¯IF/ä»•æ§˜ã€‚ã“ã‚Œã‚‰ã®ä»•æ§˜ã«å€£ã£ãŸã‚µãƒ¼ãƒã‚’"WSGIã‚µãƒ¼ãƒ" "ASGIã‚µãƒ¼ãƒ"ã¨ã„ã†ã€‚<br>
ğŸ‘‰ WSGI<br>
ã€€ãƒ»WSGIã¯ä¼çµ±çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹ç™ºã«é©ã—ã¦ã„ã¾ã™ã€‚<br>
ã€€ãƒ»å¤šãã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒWSGIã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚<br>
ã€€ãƒ»WSGIã¯**åŒæœŸçš„ãªé€šä¿¡ãƒ¢ãƒ‡ãƒ«**ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯1ã¤ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¾ãŸã¯ãƒ—ãƒ­ã‚»ã‚¹ã§å‡¦ç†ã•ã‚Œã¾ã™ã€‚<br>
ã€€ãƒ»WSGIã¯å˜ç´”ãªè¨­è¨ˆã‚’æŒã£ã¦ãŠã‚Šã€ç†è§£ã—ã‚„ã™ã„ã§ã™ã€‚<br>
ã€€âœ…**NormalãªREST APIã‚’ã¤ãã‚‹ãªã‚‰WSGIã‚µãƒ¼ãƒã§OKã€‚**<br>
<br>
ğŸ‘‰ ASGI<br>
ã€€ãƒ»ASGIã¯éåŒæœŸé€šä¿¡ãƒ¢ãƒ‡ãƒ«ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚éåŒæœŸI/Oã‚„ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‹ã®å‡¦ç†ãŒå¯èƒ½ã§ã™ã€‚<br>
ã€€ãƒ»ASGIã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„WebSocketãªã©ã€éåŒæœŸé€šä¿¡ãŒå¿…è¦ãªç”¨é€”ã«é©ã—ã¦ã„ã¾ã™ã€‚<br>
ã€€**âœ…ãƒãƒ£ãƒƒãƒˆã‚„ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãªã©ã«é©ã—ã¦ã„ã‚‹ï¼Ÿ**<br>
<br>
ğŸ‘‰FastAPIã®å®Ÿè¡Œç’°å¢ƒã§ã‚ã‚‹uvicornã¯ASGIã‚µãƒ¼ãƒã®ï¼‘ã¤ã§ã‚ã‚‹ã€‚<br>
ğŸ‘‰ASGIã®å‰èº«ã¨ã—ã¦WSGIãŒã‚ã‚‹ã€‚é•ã„ã¯async/awaitã‚’ä½¿ãˆã‚‹ã‹ã©ã†ã‹ã€‚

### WSGI Frameworks(WSGIã‚µãƒ¼ãƒä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹å‰æ)
Bottle, Falcon, Flask, Django

### WSGIã‚µãƒ¼ãƒ
ãƒ»Gunicorn<br>
ãƒ»uWSGI<br>

### ASGI Frameworks(ASGIã‚µãƒ¼ãƒä¸Šã§å®Ÿè¡Œã•ã‚Œã‚‹å‰æ)
Quart, FastAPI, Responder, Starlette, Django(Channels)

### ASGIã‚µãƒ¼ãƒ
ãƒ»Hypercorn<br>
ãƒ»uvicorn<br>
ãƒ»Daphne<br>
ãƒ»Mangum<br>

# Dockerã§ãƒ­ãƒ¼ã‚«ãƒ«èµ·å‹•ã™ã‚‹ã¨ã“ã‚ã¾ã§ã‚„ã£ã¦ã¿ã‚‹ã€‚
[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://fastapi.tiangolo.com/ja/deployment/docker/)é€šã‚Šã«é€²ã‚ã¦ã¿ã‚‹ã€‚
```
mkdir fastapi-practice
cd fastapi-practice 
```
```js:Dockerfileä½œæˆ
FROM tiangolo/uvicorn-gunicorn-fastapi:python3.7

COPY ./app /app
```
```py:app/main.pyä½œæˆ
from typing import Optional

from fastapi import FastAPI

app = FastAPI()


@app.get("/")
def read_root():
    return {"Hello": "World"}


@app.get("/items/{item_id}")
def read_item(item_id: int, q: Optional[str] = None):
    return {"item_id": item_id, "q": q}
```
```js:Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
cd python-practice
docker build -t myimage .
```
```js:ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚‚ã¨ã«ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
docker run -d --name mycontainer -p 80:80 myimage
```
âœ…FastAPIã¯SwaggerUIãŒã™ãä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
ãƒ»SwaggerUIã¸ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ http://localhost:80/docs
ãƒ»OpenAPI docs: http://localhost/openapi.json

APIã‚³ãƒ¼ãƒ«å¯èƒ½ãªã“ã¨ã‚’ç¢ºèªã€‚
```
C:\Users\daisu\Desktop\python-practice>curl http://localhost:80/
{"Hello":"World"}
```
## ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­èº«è¦‹ã¦ã¿ã‚‹ã€‚
ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸"tiangolo/uvicorn-gunicorn-fastapi:python3.7"ã®[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](
https://hub.docker.com/layers/tiangolo/uvicorn-gunicorn-fastapi/python3.7-2020-04-12/images/sha256-354b9302a82750b15f3dfc5c3884ddde50205585833c3bc70356c690c62f4c3c?context=explore)ã‚’è¦‹ã¦ã¿ã‚‹ã€‚ã©ã†ã‚„ã‚‰docker runã§ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«ä»¥ä¸‹ã®ã“ã¨ã‚’ã‚„ã£ã¦ã„ã‚‹ã€‚
```js:pipã§uvicornã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
/bin/sh -c pip install uvicorn
```
```js:pipã§fastapiã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
/bin/sh -c pip install fastapi
```
```js:uvicornã®èµ·å‹•
exec uvicorn --reload --host $HOST --port $PORT --log-level $LOG_LEVEL "$APP_MODULE"
```

# Dockerã§ã¯ãªãã€ãƒ­ãƒ¼ã‚«ãƒ«(Windows10)ä¸Šã§ç’°å¢ƒæ§‹ç¯‰ã—ã¦ã¿ã‚‹ã€‚
ä¸Šè¨˜ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã¯ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦`pip`ãŒåˆ©ç”¨ã•ã‚Œã¦ã„ãŸã€‚<br>
å··ã§ã¯`pip`ã‚’å†…éƒ¨ã§åˆ©ç”¨ã—ã¦ã„ã‚‹`poetry`ãŒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦äººæ°—ã®ã‚ˆã†ãªã®ã§ã€ã“ã‚Œã‚’ä½¿ã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã‚‚FastAPIã‚’èµ·å‹•ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã‚‹ã€‚

## æ‰‹é †1. poetryã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚
[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://python-poetry.org/docs/#installing-with-the-official-installer)é€šã‚Šã«ã‚„ã£ã¦ã¿ã‚‹ã€‚
```js:Powershellã§ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã€‚
(Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | py -

Poetry (1.3.2) is installed now. Great!

To get started you need Poetry's bin directory (C:\Users\daisu\AppData\Roaming\Python\Scripts) in your `PATH`
environment variable.

Alternatively, you can call Poetry explicitly with `C:\Users\daisu\AppData\Roaming\Python\Scripts\poetry`.

You can test that everything is set up by executing:

`poetry --version`
```
ğŸ‘‰`C:\Users\daisu\AppData\Roaming\Python\Scripts\poetry`ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã€‚
ğŸ‘‰PATHã«`C:\Users\daisu\AppData\Roaming\Python\Scripts`ã‚’è¿½åŠ ã€‚
```js:ç¢ºèª
C:\Users\daisu>poetry --version
Poetry (version 1.3.2)
```


## æ‰‹é †2: poetryã‚’ç”¨ã„ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé››å‹ä½œæˆ
`poetry new`ã‚³ãƒãƒ³ãƒ‰ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®é››å‹ã‚’ä½œæˆã—ã¦ãã‚Œã‚‹[ã‚‰ã—ã„](https://cocoatomo.github.io/poetry-ja/cli/#new)ã®ã§ä½¿ã†ã€‚
```
cd ä»»æ„ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
poetry new fastapi-practice
```
ã“ã‚“ãªæ„Ÿã˜ã€‚
![](https://storage.googleapis.com/zenn-user-upload/d781ae29b3c6-20230125.png)

## æ‰‹é †3. poetryã‚’ç”¨ã„ã¦ã€fastapiã¨uvicornã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚
```
poetry add fastapi uvicorn
```
ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`pyproject.toml`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¾å­˜ãŒè¿½åŠ ã•ã‚Œã‚‹ã€‚
```diff toml:pyproject.toml
[tool.poetry]
name = "fastapi-practice"
version = "0.1.0"
description = ""
authors = ["daisuke.takakuwa <daisuke.takakuwa@monocrea.co.jp>"]
readme = "README.md"
packages = [{include = "fastapi_practice"}]

[tool.poetry.dependencies]
python = "^3.11"
+fastapi = "^0.89.1"
+uvicorn = "^0.20.0"


[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```
## æ‰‹é †4. HELLO WORLDã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã€‚
```py:fastapi_practice/__init__.py
from typing import Optional

from fastapi import FastAPI

app = FastAPI()


@app.get("/")
def read_root():
    return {"Hello": "World"}
```
## æ‰‹é †5. uvicornèµ·å‹•ã€‚
âœ…`poetry shell`ã§uvicornã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ä»®æƒ³ç’°å¢ƒ(ã‚·ã‚§ãƒ«)ã‚’ç”¨æ„ã—ã¦ãã‚Œã‚‹ã€‚
```
poetry shell
uvicorn --reload --port 8888 "fastapi_practice.__init__:app"
```

# poetryã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«"ä»®æƒ³ç’°å¢ƒ"ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚
âœ…`poetry env info`ã‚³ãƒãƒ³ãƒ‰ã§ã€æ§‹ç¯‰ã—ãŸä»®æƒ³ç’°å¢ƒã®æƒ…å ±ã‚’ç¢ºèªã§ãã‚‹ã€‚
```
Virtualenv
Python:         3.11.0
Implementation: CPython
Path:           C:\Users\daisu\AppData\Local\pypoetry\Cache\virtualenvs\fastapi-practice-Yix6pG8l-py3.11
Executable:     C:\Users\daisu\AppData\Local\pypoetry\Cache\virtualenvs\fastapi-practice-Yix6pG8l-py3.11\Scripts\python.exe
Valid:          True
```
ğŸ‘‰`C:\Users\daisu\AppData\Local\pypoetry\Cache\virtualenvs\`ãƒ•ã‚©ãƒ«ãƒ€é…ä¸‹ã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã®ä»®æƒ³ç’°å¢ƒç”¨ãƒ•ã‚©ãƒ«ãƒ€ãŒä½œæˆã•ã‚Œã‚‹ã€‚
âœ…**poetryã§installã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚‚ã“ã“ã«ã‚ã‚‹ã€‚**
![](https://storage.googleapis.com/zenn-user-upload/9039f1fb2297-20230126.png)
