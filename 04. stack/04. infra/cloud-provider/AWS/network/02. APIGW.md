# ç·æ‹¬
ğŸ‘‰ï¼‘ã¤ã®APIã‚’ä½œã£ã¦ã€ãã®é…ä¸‹ã«endpoint(ãƒªã‚½ãƒ¼ã‚¹)ã‚’å®šç¾©ã—ã¦ã„ãã€‚

# APIGWã¨ã¯
APIGW<br>
ãƒ»APIã‚’å…¬é–‹ã™ã‚‹ãŸã‚ã®ç„é–¢ã¨ãªã‚‹ã‚‚ã®ã€‚<br>
ãƒ»Interfaceã¨ã—ã¦ã®å½¹å‰²ã ã‘ã§ã€ç´°ã‹ã„å‡¦ç†ã¯ãƒ—ãƒ­ã‚­ã‚·å…ˆ(Lambdaç­‰)ãŒæ‹…ã†ã“ã¨ã«ãªã‚‹ã€‚

## Protocol(REST API or HTTP API)
> REST APIs and HTTP APIs are both RESTful API products. REST APIs support more features than HTTP APIs, while HTTP APIs are designed with minimal features so that they can be offered at a lower price. Choose REST APIs if you need features such as **API keys, per-client throttling, request validation, AWS WAF integration, or private API endpoints**. Choose HTTP APIs if you don't need the features included with REST APIs.

âœ…ã©ã¡ã‚‰ã‚‚REST APIã€‚<br>
ğŸ”´HTTP APIã¯æœ€ä½é™ã®æ©Ÿèƒ½ã®ã¿ã€‚REST APIã§ã¯`API keys`ã¨ã‹ä½¿ãˆã‚‹ã€‚<br>

âœ…Endpointã¯**AWSå´ã§ä½œæˆæ¸ˆã¿ã®APIGWç”¨ã®VPCå†…ã«ä½œã‚‰ã‚Œã‚‹**ã€‚
<img width="700px" src="https://storage.googleapis.com/zenn-user-upload/caf8a5bfa801-20230610.png" />

å‚è€ƒï¼š[Understanding VPC links in Amazon API Gateway private integrations](https://aws.amazon.com/jp/blogs/compute/understanding-vpc-links-in-amazon-api-gateway-private-integrations/#:~:text=API%20Gateway%20has%20direct%20connectivity,directly%20from%20their%20own%20VPC.)

## Endpoint Type(Public or Private)

âœ…Endpoint Typeã¨ã—ã¦ä¸»ã«
- Publicï¼šã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ï¼AWSå†…éƒ¨ã§ã®é€šä¿¡ã§ã¯ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆçµŒç”±
- **Privateï¼šVPC endpointçµŒç”±ã®ã¿ã§ã—ã‹ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã€‚**

> **Private APIs are only accessible through VPC endpoints** for API Gateway.<br>
Create a VPC endpoint and add Resource Policy for the API to allow access.<br><img width="400px" src="https://storage.googleapis.com/zenn-user-upload/bd0d933702f7-20230610.png" />

âœ…PrivateãªAPIGWã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã§**VPC endpointçµŒç”±ã§ã—ã‹ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„**ã‚‚ã®ã€‚
<img width="700px" src="https://storage.googleapis.com/zenn-user-upload/f45580a1bda2-20230610.png" />

<img width="700px" src="https://github.com/daisuketakakuwa/learning-stack/assets/66095465/b9d41a50-dc7e-4f4b-a18b-0dcfded0ce44" />


å‚è€ƒï¼š[Creating a private API in Amazon API Gateway](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-private-apis.html)

ğŸ”´**VPC Endpointã®æ­£ä½“ã¯ã€ŒENIã€ã€‚**<br>
ğŸ”´VPC Endpointæ§‹ç¯‰æ™‚ã«ã€Œã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨å´(ENIã‚’æ§‹ç¯‰ã™ã‚‹æ–¹)ã®VPCã€ã€Œå‚ç…§å¯¾è±¡ã®ã‚µãƒ¼ãƒ“ã‚¹åã€ã‚’æŒ‡å®šã™ã‚‹ã€‚<br>
âœ…ä»Šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã ã¨ã€Openshiftã®WEBã‚µãƒ¼ãƒãŒå±ã™ã‚‹VPCãŒã‚ã£ã¦ã€ãã“ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãªã‚‹ã ã‚ã†ã€‚

### Private APIã‚’å‘¼ã³å‡ºã™æ–¹æ³•
æ–¹æ³•ã¯Xã¤ã€‚
1. Route53Aliasã‚’åˆ©ç”¨ã™ã‚‹ã€‚
2.

å‚è€ƒï¼š[Route53 ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½¿ç”¨ã—ãŸãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ API ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/apigateway-private-api-test-invoke-url.html#apigateway-private-api-route53-alias)

#### 1. Route53Aliasã‚’åˆ©ç”¨ã™ã‚‹ã€‚
âœ…ã€ŒAPIGWã®IDã€ã¨ã€ŒVPCEndpointã®IDã€ã‚’ä½¿ã£ã¦Route53ã«**Publicãª**DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ<br>
ã€€ã€€= **APIGWã‚’ä½œæˆã™ã‚‹ã¨ãã«VPCEndpointã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€APIGWç”Ÿæˆæ™‚ã«ã“ã®DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚ä½œã£ã¦ãã‚Œã‚‹ã€‚**

âœ… ç”Ÿæˆã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³"{rest-api-id}-{vpce-id}.execute-api.{region}.amazonaws.com"ã¯InternetçµŒç”±ã§ã‚‚DNSåå‰è§£æ±ºã§ãã‚‹ãŒã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã§å‚ç…§ã§ããªã„ã€‚

> ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ API ã® REST API ID ã‚’ REST API ã®å‘¼ã³å‡ºã—å…ƒã® VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é–¢é€£ä»˜ã‘ã‚‹ã¨ã€Route53 ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’ä½¿ç”¨ã—ã¦ API ã‚’å‘¼ã³å‡ºã™ãŸã‚ã«ã€æ¬¡ã®å½¢å¼ã®ãƒ™ãƒ¼ã‚¹ URL ã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚
> https://{rest-api-id}-{vpce-id}.execute-api.{region}.amazonaws.com

#### æ¤œè¨¼
APIGW -> Lambda(Mock) ã§"HELLO WORLD"ã‚’è¿”ã™æ§‹æˆã€‚<br>
âœ…VPC/PrivateSubnetAä½œæˆã€‚<br>
âœ…VPCEndpointAä½œæˆ@PrivateSubnetAã€‚<br>
âœ…PrivateãªAPIGWã‚’ä½œæˆã€‚<br>
ã€€âœ…IntegrationEndpoint ã¨ã—ã¦ Lambda(Mock) ã‚’è¨­å®š<br>
ã€€âœ…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ç”»é¢ã‚ˆã‚ŠLambda(Mock)ã‚’ã‚³ãƒ¼ãƒ«ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã€‚<br>
ã€€âœ…VPCEndpointã¨ã—ã¦VPCEndpointAã‚’è¨­å®šã€‚ï¼ˆRoute53Aliasã‚’ç”Ÿæˆã—ã¦ã‚‚ã‚‰ã†ï¼‰<br>
ã€€- Serverlessã§æ§‹ç¯‰ã™ã‚‹ã€‚<br>

å‹•ä½œç¢ºèª<br>
ğŸ”´SubnetAå†…ã«EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆï¼†SSHãƒ­ã‚°ã‚¤ãƒ³ã€‚<br>
ğŸ”´Route53Aliasãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦è¨­å®šã—ãŸURLã§ã€curlã—ã¦ã¿ã‚‹ã€‚<br>
â˜…ä»Šã®ã¨ã“ã‚ã€APIGWã«ResourcePolicyã‚’è¨­å®šã—ã¦ãªã„ã€‚

> ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ API ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã¯ã€**VPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ DNS ã‚’æœ‰åŠ¹ã«ã—ãŸã‹ã©ã†ã‹**ã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™ã€‚
> å‚è€ƒï¼š[ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ API ã‚’å‘¼ã³å‡ºã™æ–¹æ³•](https://docs.aws.amazon.com/ja_jp/apigateway/latest/developerguide/apigateway-private-api-test-invoke-url.html)

#### ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆDNSã¨ã¯
ãã®VPCå†…ã ã‘ã§åå‰è§£æ±ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
ãã®VPCå†…ã ã‘ã§å‚ç…§ã§ãã‚‹DNSã‚µãƒ¼ãƒã‚’æ§‹ç¯‰ã™ã‚‹æ„Ÿã˜ã€‚

## èªè¨¼(Lambda(Custom) Authorizor)
APIGWãŒå…¬é–‹ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ãŸã¨ãã«èªè¨¼å‡¦ç†ã‚’èµ°ã‚‰ã›ã‚‹æ‰‹æ®µãŒã„ãã¤ã‹æä¾›ã•ã‚Œã¦ãŠã‚Šã€Protocol(REST/HTTP)ã«ã‚ˆã£ã¦åˆ©ç”¨å¯èƒ½ãªã‚‚ã®ãŒå¤‰ã‚ã£ã¦ãã‚‹ã€‚ä»Šå›ã¯[Lambda authorizoer(Custom authorizor)](https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-use-lambda-authorizer.html)ã‚’æ¡ç”¨ã™ã‚‹ã€‚
<img width="600px" src="https://storage.googleapis.com/zenn-user-upload/5d5964039a5e-20230602.png" />
[Choosing between REST APIs and HTTP APIs](https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-vs-rest.html)

> A Lambda authorizer (formerly known as a custom authorizer) is **an API Gateway feature** that **uses a Lambda function** to control access to your API.
A Lambda authorizer is useful if you want to implement a custom authorization scheme that uses a bearer token authentication strategy such as OAuth or SAML, or that uses request parameters to determine the caller's identity.

âœ…APIGWã®æ©Ÿèƒ½ã€‚<br>
âœ…é–‹ç™ºè€…ãŒå®Ÿè£…ã—ãŸLambdaã‚’èªè¨¼ç”¨ã®é–¢æ•°ã¨ã—ã¦åˆ©ç”¨ã§ãã‚‹ã€‚<br>
ğŸ”´IDãƒ—ãƒ­ãƒã‚¤ãƒ€ã‹ã‚‰JWKSå–å¾—ã—ãŸã‚Šã€ãƒˆãƒ¼ã‚¯ãƒ³å†…ã®ãƒ­ãƒ¼ãƒ«æœ‰ç„¡ç¢ºèªã—ãŸã‚Šã¨ã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ãŸã„ã“ã¨ãŒã‚ã‚‹å ´åˆã“ã‚Œã‚’åˆ©ç”¨ã™ã‚‹ã€‚<br>
ğŸ”´èªè¨¼çµæœã¨ã—ã¦**IAM policyã‚’è¿”å´ã™ã‚‹å¿…è¦**ãŒã‚ã‚‹ã€‚

## Integration Endpoint
âœ…1ã¤ã®APIGWã‚’ä½œã£ã¦ã€ãã®é…ä¸‹ã«1ã¤ä»¥ä¸Šã®APIãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œæˆã—ã¦ã„ãã€‚<br>
âœ…**å„APIãƒ¡ã‚½ãƒƒãƒ‰ã‚’Backend Serviceã«ç´ã¥ã‘ã‚‹**ä½œæ¥­ã‚’ã™ã‚‹ = IntegrationğŸ‘<br>
âœ…ã“ã®Backend Serviceã¯**Integration Endpoint**ã¨å‘¼ã³ã€Lambdaé–¢æ•°ã‚’ã¯ã˜ã‚ã¨ã—ãŸã‚‚ã®ã€‚<br>
[Setting up REST API integrations](https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-integration-settings.html)

### Integration Request/Response
Intergration Endpointã¨ã—ã¦ã‚ã‚‹Lambdaé–¢æ•°Aã‚’é¸æŠã—ãŸå ´åˆã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

ã€€Client â‡” APIGW â‡”â˜…â‡” Lambdaé–¢æ•°A

â˜…éƒ¨åˆ†ã®ã‚„ã‚Šå–ã‚Šã¯**Integration Request/Integration Response**ã¨å‘¼ã°ã‚Œã€ã“ã“ã®IFã¯Integration Endpointã‚’ä½•ã«ã—ãŸã‹ã§å¤‰ã‚ã£ã¦ãã‚‹(ã ã‚ã†)

### Integration Endpointã«Lambdaã‚’è¨­å®šã™ã‚‹æ–¹æ³•
> You can integrate an API method with a Lambda function using **Lambda proxy integration** or **Lambda non-proxy (custom) integration**.

ğŸ”´APIãƒ¡ã‚½ãƒƒãƒ‰ã®Integration Endpointã«Lambdaé–¢æ•°ã‚’å®šç¾©ã™ã‚‹æ‰‹æ®µã¯ï¼’ã¤ã€‚
1. Lambda **proxy** integration
2. Lambda **non-proxy(custom)** integration

#### Lambda proxy integration
æ–‡å­—é€šã‚ŠProxyã™ã‚‹ã ã‘ã€‚
[Set up Lambda proxy integrations in API Gateway](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html)


[Set up Lambda integrations in API Gateway](https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-integrations.html)

## APIGWã®Resouce Policyã§å‚ç…§å¯èƒ½ãªVPC(ENIã‚’é…ç½®ã—ãŸVPC)ã‚’å®šç¾©ã€‚
âœ…`aws:SourceVpce`ã§VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ(ENI)ã‚’å®šç¾©ã™ã‚‹ã€‚<br>
ã€€= ã“ã†ã™ã‚Œã°ãã®VPCã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿å—ã‘ä»˜ã‘ã‚‹ã€‚<br>
ğŸ”´ä½•ã‚‚VPCã‚’æŒ‡å®šã—ãªã‹ã£ãŸå ´åˆã€å…¨ã¦ã®VPCã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å—ã‘ä»˜ã‘ã‚‹...**å®Ÿè³ªPublicãªã®ã§ã¯ï¼Ÿ**

> To restrict access to specific VPCs and VPC endpoints, **you must include 'aws:SourceVpc' and 'aws:SourceVpce' conditions** in your API's resource policy. If your policy does not include any of these conditions, your API will be accessible by all VPCs

## Private APIGWã§ã‚‚ã€`aws:SourceVpce`ã‚’ResourcePolicyã«å®šç¾©ã—ãªã‹ã£ãŸã‚‰Publicï¼Ÿ


# Lambda
âœ…Lambdaã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§**AWSå´ã§ä½œæˆæ¸ˆã¿ã®Lambdaç”¨ã®VPCå†…ã«ä½œã‚‰ã‚Œã‚‹**ã€‚

# Lambda(function URL) ã¨ APIGW ã®é•ã„
Lambdaã‚’HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å‘¼ã³å‡ºã™ã€ã¨ã„ã†ç‚¹ã§åŒã˜ã€‚ã˜ã‚ƒã‚ã©ã£ã¡ä½¿ã†ã‚ˆï¼Ÿ<br>
âœ…APIGWã«ã—ã‹ãªã„è¦ç´ ã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€APIGWï¼‹Lambdaã€‚<br>
âœ…Lambdaã ã‘ã§äº‹è¶³ã‚Šã‚‹ãªã‚‰ã€function URL(ã¾ãŸã¯function URLã‚‚ä½¿ã‚ãªã„)







# ã‚ã¨ã§æ¤œè¨¼
ä»¥ä¸‹ã®æ§‹æˆã§Private APIGWã‚’æ§‹ç¯‰ã—ãŸå ´åˆã€Publicã«ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’Callã™ã‚‹ã“ã¨ã¯å¯èƒ½ãªã®ã‹ï¼Ÿ

ã€€ãŠã‚Œã€€-ã€€VPC Endpointã€€-ã€€APIGW Endpoint(Private)ã€€-ã€€Lambda

URLã¯ä»¥ä¸‹ã®å½¢å¼
https://{vpce-id}.execute-api.{region}.amazonaws.com/{path}

```json:PrivateãªAPIGWã«è¨­å®šã™ã‚‹Resource Policy
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": "*",
            "Action": "execute-api:Invoke",
            "Resource": "execute-api:/*"
        }
    ]
}
```

ğŸ”´APIGWã®Resource Policyã«`aws:SourceVpc`ã‚’ä½¿ã£ã¦è¨­å®šã—ãªã„ã¨ã€å…¨ã¦ã®VPCã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã™ã‚‹ã“ã¨ã«ãªã‚‹ã€‚
```json:VPC(vpc-1a2b3c4d)ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã¿ã‚’è¨±å¯ã—ãŸè¨­å®š
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": "*",
            "Action": "execute-api:Invoke",
            "Resource": [
                "execute-api:/*"
            ]
        },
        {
            "Effect": "Deny",
            "Principal": "*",
            "Action": "execute-api:Invoke",
            "Resource": [
                "execute-api:/*"
            ],
            "Condition" : {
                "StringNotEquals": {
                   "aws:SourceVpc": "vpc-1a2b3c4d"
                }
            }
        }
    ]
}
```
